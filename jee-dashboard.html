<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JEE Dashboard - GyaanSetu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 26px; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.15);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.6);
      cursor: pointer;
      font-size: 13px;
    }

    .logout-btn:hover { background: rgba(255,255,255,0.25); }

    .container {
      max-width: 1400px;
      margin: 25px auto 40px;
      padding: 0 20px;
    }

    .section-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 12px rgba(15,23,42,0.06);
      margin-bottom: 25px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .section-header h2 {
      font-size: 18px;
      color: #111827;
    }

    .section-header span {
      font-size: 12px;
      color: #6b7280;
    }

    /* Countdown */
    .exam-countdown {
      background: linear-gradient(135deg, #34d399 0%, #22c55e 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      margin-bottom: 25px;
    }

    .exam-countdown h2 { font-size: 22px; margin-bottom: 10px; }

    .exam-subtitle {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .countdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin: 15px 0 10px;
    }

    .countdown-item {
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }

    .countdown-item .number {
      font-size: 24px;
      font-weight: 700;
    }

    .countdown-item .label {
      font-size: 13px;
      opacity: 0.9;
    }

    .quote {
      font-style: italic;
      margin-top: 10px;
      font-size: 14px;
      opacity: 0.96;
    }

    /* Update progress */
    .update-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .update-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 14px 16px;
      border: 1px solid #e5e7eb;
    }

    .update-box label {
      display: block;
      margin-bottom: 6px;
      color: #4b5563;
      font-size: 13px;
      font-weight: 600;
    }

    .update-box input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      font-size: 14px;
    }

    .update-box input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16,185,129,0.15);
    }

    .update-actions {
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
    }

    .btn {
      padding: 11px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn:hover {
      box-shadow: 0 8px 18px rgba(16,185,129,0.35);
      transform: translateY(-1px);
    }

    /* Totals cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .stat-card {
      background: white;
      padding: 16px 18px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(15,23,42,0.06);
      border-left: 4px solid #10b981;
    }

    .stat-card h3 {
      color: #4b5563;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .stat-card .number {
      font-size: 26px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .stat-card .meta {
      font-size: 12px;
      color: #6b7280;
    }

    .empty-state {
      text-align: center;
      padding: 28px 10px;
      color: #9ca3af;
      font-size: 13px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .list-item {
      font-size: 13px;
      color: #111827;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #dcfce7;
      color: #047857;
      margin-left: 6px;
    }

    @media (max-width: 640px) {
      .header {
        padding: 16px 18px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .container {
        padding: 0 14px;
      }
    }
  </style>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFiEVyWCStmdOxaSz2AAboplrOXAJn0XuW614KRzLihSL60qL8zy3GEgBVvm0DQPcmQg/exec';

    // Access guard: only logged-in JEE users
    (function guardAccess() {
      const exam = localStorage.getItem('exam');
      const userId = localStorage.getItem('userId');

      if (!exam || !userId || exam !== 'JEE') {
        window.location.href = 'index.html';
      }
    })();
  </script>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <h1>JEE Dashboard</h1>
    <div class="header-right">
      <span id="userName">Welcome</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <!-- COUNTDOWN -->
    <section class="exam-countdown">
      <h2>JEE Main & JEE Advanced 2026</h2>
      <div class="exam-subtitle">
        Every problem solved today brings you closer to your dream rank.
      </div>
      <div class="countdown-grid">
        <div class="countdown-item">
          <div class="number" id="daysLeft1">0</div>
          <div class="label">JEE Main Session 1 · Days Left</div>
        </div>
        <div class="countdown-item">
          <div class="number" id="hoursLeft1">0</div>
          <div class="label">JEE Main Session 1 · Hours Left</div>
        </div>
        <div class="countdown-item">
          <div class="number" id="daysLeft2">0</div>
          <div class="label">JEE Main Session 2 · Days Left</div>
        </div>
        <div class="countdown-item">
          <div class="number" id="hoursLeft2">0</div>
          <div class="label">JEE Main Session 2 · Hours Left</div>
        </div>
        <div class="countdown-item">
          <div class="number" id="daysLeftAdv">0</div>
          <div class="label">JEE Advanced · Days Left</div>
        </div>
        <div class="countdown-item">
          <div class="number" id="hoursLeftAdv">0</div>
          <div class="label">JEE Advanced · Hours Left</div>
        </div>
      </div>
      <div class="quote" id="dailyQuote">
        Great concepts are built one solved question at a time.
      </div>
    </section>

    <!-- UPDATE DAILY PROGRESS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Update Your Daily Progress</h2>
        <span>Track your JEE preparation honestly</span>
      </div>
      <form id="progressForm" onsubmit="updateProgress(event)">
        <div class="update-grid">
          <div class="update-box">
            <label for="studyHours">Study Hours Today</label>
            <input type="number" id="studyHours" min="0" step="0.5" placeholder="e.g. 6" required>
          </div>
          <div class="update-box">
            <label for="topicsCovered">Topics Covered Today</label>
            <input type="number" id="topicsCovered" min="0" step="1" placeholder="Chapters/Topics" required>
          </div>
          <div class="update-box">
            <label for="mockTests">Questions / Tests</label>
            <input type="number" id="mockTests" min="0" step="1" placeholder="Questions or tests count" required>
          </div>
          <div class="update-box update-actions">
            <button type="submit" class="btn">Save & Add to Totals</button>
          </div>
        </div>
      </form>
    </section>

    <!-- OVERALL TOTALS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Overall Progress Totals</h2>
        <span>Calculated from your daily entries</span>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Study Hours</h3>
          <div class="number" id="totalHours">0</div>
          <div class="meta">Physics · Chemistry · Maths combined</div>
        </div>
        <div class="stat-card">
          <h3>Topics Covered</h3>
          <div class="number" id="totalTopics">0</div>
          <div class="meta">Key topics across all three subjects</div>
        </div>
        <div class="stat-card">
          <h3>Questions / Tests</h3>
          <div class="number" id="totalTests">0</div>
          <div class="meta">Questions attempted / tests taken</div>
        </div>
      </div>
    </section>

    <!-- PERFORMANCE ANALYTICS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Performance Analytics</h2>
        <span>Average effort & consistency streak</span>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Average Study Hours</h3>
          <div class="number" id="avgHours">0</div>
          <div class="meta">Per active study day</div>
        </div>
        <div class="stat-card">
          <h3>Current Streak</h3>
          <div class="number" id="streakDays">0</div>
          <div class="meta">Consecutive days with study log</div>
        </div>
      </div>
    </section>

    <!-- ANNOUNCEMENTS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Announcements</h2>
        <span>JEE related updates from admin</span>
      </div>
      <div id="announcements">
        <div class="empty-state">No announcements yet. Admin will update here.</div>
      </div>
    </section>

    <!-- TEST PORTAL -->
    <section class="section-card">
      <div class="section-header">
        <h2>Test Portal</h2>
        <span>Test Series · Previous Year Questions</span>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin-bottom:8px;">Test Series</h3>
      <div id="testSeriesList">
        <div class="empty-state">Admin will upload test series soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Previous Year Questions (PYQs)</h3>
      <div id="pypList">
        <div class="empty-state">Admin will upload PYQ PDFs soon.</div>
      </div>
    </section>

    <!-- STUDY MATERIALS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Study Materials</h2>
        <span>Books · Formula sheets · Notes</span>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin-bottom:8px;">Books</h3>
      <div id="booksList">
        <div class="empty-state">Admin will upload books list soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Important Formula Sheets</h3>
      <div id="formulaList">
        <div class="empty-state">Admin will upload formula sheets soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Notes & PDFs</h3>
      <div id="notesList">
        <div class="empty-state">Admin will upload notes & PDFs soon.</div>
      </div>
    </section>

    <!-- PATH PRADARSHAK -->
    <section class="section-card">
      <div class="section-header">
        <h2>पथ प्रदर्शक</h2>
        <span>Daily motivation for JEE aspirants</span>
      </div>
      <div id="motivationalQuotes">
        <div class="empty-state">Admin will share motivational quotes soon.</div>
      </div>
    </section>
  </div>

  <script>
    // JEE daily quotes (local)
    const jeeQuotes = [
      'Every hour you study today is one less mark of regret on exam day.',
      'Strong basics beat last-minute panic every single time.',
      'Solve one more question; future you will thank you.',
      'Consistency turns average students into top rankers.',
      'JEE is tough, but so are you.'
    ];

    function loadDailyQuote() {
      const todayKey = new Date().toISOString().slice(0, 10);
      const stored = localStorage.getItem('jeeQuote');
      let quote;

      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (parsed.date === todayKey) {
            quote = parsed.text;
          }
        } catch (e) {}
      }

      if (!quote) {
        quote = jeeQuotes[Math.floor(Math.random() * jeeQuotes.length)];
        localStorage.setItem('jeeQuote', JSON.stringify({ date: todayKey, text: quote }));
      }

      document.getElementById('dailyQuote').textContent = quote;
    }

    // Fixed countdown numbers
    function updateCountdown() {
      document.getElementById('daysLeft1').textContent  = 17;
      document.getElementById('hoursLeft1').textContent = 420;
      document.getElementById('daysLeft2').textContent  = 89;
      document.getElementById('hoursLeft2').textContent = 2124;
      document.getElementById('daysLeftAdv').textContent  = 133;
      document.getElementById('hoursLeftAdv').textContent = 3204;
    }

    function logout() {
      if (confirm('Logout from GyaanSetu?')) {
        localStorage.removeItem('userId');
        localStorage.removeItem('name');
        localStorage.removeItem('exam');
        window.location.href = 'index.html';
      }
    }

    // STUDY PROGRESS
    function updateProgress(e) {
      e.preventDefault();

      const userId = localStorage.getItem('userId');
      const exam   = localStorage.getItem('exam');

      if (!userId || !exam) {
        alert('Session expired. Please login again.');
        window.location.href = 'index.html';
        return;
      }

      const hours  = parseFloat(document.getElementById('studyHours').value) || 0;
      const topics = parseInt(document.getElementById('topicsCovered').value || '0', 10);
      const mocks  = parseInt(document.getElementById('mockTests').value || '0', 10);

      const url = `${SCRIPT_URL}?action=logStudy` +
                  `&userId=${encodeURIComponent(userId)}` +
                  `&exam=${encodeURIComponent(exam)}` +
                  `&hours=${encodeURIComponent(hours)}` +
                  `&topics=${encodeURIComponent(topics)}` +
                  `&mocks=${encodeURIComponent(mocks)}`;

      fetch(url)
        .then(r => {
          if (!r.ok) throw new Error('Network error: ' + r.status);
          return r.json();
        })
        .then(data => {
          if (!data || !data.success) {
            throw new Error(data && data.message ? data.message : 'Failed to save study log');
          }

          const totalsUrl = `${SCRIPT_URL}?action=getStudyTotals` +
                            `&userId=${encodeURIComponent(userId)}` +
                            `&exam=${encodeURIComponent(exam)}`;
          return fetch(totalsUrl).then(r => r.json());
        })
        .then(totals => {
          if (totals && totals.success) {
            document.getElementById('totalHours').textContent  = totals.totalHours || 0;
            document.getElementById('totalTopics').textContent = totals.totalTopics || 0;
            document.getElementById('totalTests').textContent  = totals.totalMocks || 0;
          } else {
            throw new Error(totals && totals.message ? totals.message : 'Failed to load totals');
          }
          alert('Progress updated successfully!');
          document.getElementById('progressForm').reset();
          loadAnalytics();
        })
        .catch(err => {
          console.error('Update progress error:', err);
          alert('Error updating progress: ' + err.message);
        });
    }

    function loadTotals() {
      const userId = localStorage.getItem('userId');
      const exam   = localStorage.getItem('exam');
      if (!userId || !exam) return;

      const totalsUrl = `${SCRIPT_URL}?action=getStudyTotals` +
                        `&userId=${encodeURIComponent(userId)}` +
                        `&exam=${encodeURIComponent(exam)}`;

      fetch(totalsUrl)
        .then(r => r.json())
        .then(totals => {
          if (totals && totals.success) {
            document.getElementById('totalHours').textContent  = totals.totalHours || 0;
            document.getElementById('totalTopics').textContent = totals.totalTopics || 0;
            document.getElementById('totalTests').textContent  = totals.totalMocks || 0;
          }
        })
        .catch(err => console.error('Load totals error:', err));
    }

    function loadAnalytics() {
      const userId = localStorage.getItem('userId');
      const exam   = localStorage.getItem('exam');
      if (!userId || !exam) return;

      const url = `${SCRIPT_URL}?action=getStudyAnalytics` +
                  `&userId=${encodeURIComponent(userId)}` +
                  `&exam=${encodeURIComponent(exam)}`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data || !data.success) return;
          document.getElementById('avgHours').textContent =
            (data.avgHours || 0).toFixed(1);
          document.getElementById('streakDays').textContent =
            data.streakDays || 0;
        })
        .catch(err => console.error('loadAnalytics error:', err));
    }

    // LIST RENDERERS
    function renderSimpleList(containerId, items) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (!items || !items.length) {
        container.innerHTML = '<div class="empty-state">No data yet.</div>';
        return;
      }
      const list = document.createElement('div');
      list.className = 'list';
      items.forEach(text => {
        const row = document.createElement('div');
        row.className = 'list-item';
        row.textContent = typeof text === 'string' ? text : (text.text || text.title || '');
        list.appendChild(row);
      });
      container.appendChild(list);
    }

    function renderHighlightList(containerId, items, highlightLabel) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (!items || !items.length) {
        container.innerHTML = '<div class="empty-state">No data yet.</div>';
        return;
      }
      const list = document.createElement('div');
      list.className = 'list';
      items.forEach((it, index) => {
        const row = document.createElement('div');
        row.className = 'list-item';
        row.textContent = typeof it === 'string' ? it : (it.text || it.title || '');
        if (index === 0 && highlightLabel) {
          row.style.fontWeight = '600';
          row.style.background = '#fef3c7';
          row.style.borderRadius = '6px';
          row.style.padding = '6px 8px';
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = highlightLabel;
          row.appendChild(tag);
        }
        list.appendChild(row);
      });
      container.appendChild(list);
    }

    function renderAnnouncements(items) {
      const container = document.getElementById('announcements');
      container.innerHTML = '';
      if (!items || !items.length) {
        container.innerHTML = '<div class="empty-state">No announcements yet. Admin will update here.</div>';
        return;
      }

      const list = document.createElement('div');
      list.className = 'list';
      items.forEach((it, index) => {
        const row = document.createElement('div');
        row.className = 'list-item';
        row.textContent = typeof it === 'string' ? it : (it.text || it.title || '');
        if (index === 0) {
          row.style.fontWeight = '600';
          row.style.background = '#eef2ff';
          row.style.borderRadius = '6px';
          row.style.padding = '6px 8px';
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = 'NEW';
          row.appendChild(tag);
        }
        list.appendChild(row);
      });
      container.appendChild(list);
    }

    // DASHBOARD CONTENT (examType=JEE)
    function loadJeeDashboardContent() {
      const url = `${SCRIPT_URL}?action=getDashboardContent&examType=JEE`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data || !data.success || !data.payload) return;
          const p = data.payload;

          if (p.announcements && Array.isArray(p.announcements.items)) {
            renderAnnouncements(p.announcements.items);
          }

          if (p.testSeries && Array.isArray(p.testSeries.items)) {
            renderHighlightList('testSeriesList', p.testSeries.items, 'NEW');
          }

          if (p.pyqPapers && Array.isArray(p.pyqPapers.items)) {
            renderHighlightList('pypList', p.pyqPapers.items, 'NEW');
          }

          if (p.books && Array.isArray(p.books.items)) {
            renderHighlightList('booksList', p.books.items, 'NEW');
          }

          if (p.formulaSheets && Array.isArray(p.formulaSheets.items)) {
            renderHighlightList('formulaList', p.formulaSheets.items, 'NEW');
          }

          if (p.notesPdfs && Array.isArray(p.notesPdfs.items)) {
            renderHighlightList('notesList', p.notesPdfs.items, 'NEW');
          }

          if (p.quotes && Array.isArray(p.quotes.items) && p.quotes.items.length) {
            renderHighlightList('motivationalQuotes', p.quotes.items, 'NEW');
          }
        })
        .catch(err => console.error('loadJeeDashboardContent error:', err));
    }

    window.onload = function() {
      document.getElementById('userName').textContent =
        localStorage.getItem('name') || 'Candidate';

      updateCountdown();
      loadDailyQuote();
      loadTotals();
      loadAnalytics();
      loadJeeDashboardContent();
    };
  </script>
</body>
</html>
