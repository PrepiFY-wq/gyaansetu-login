<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UPSC CSE Dashboard - GyaanSetu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 26px; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.15);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.6);
      cursor: pointer;
      font-size: 13px;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .container {
      max-width: 1400px;
      margin: 25px auto 40px;
      padding: 0 20px;
    }

    .section-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 12px rgba(15,23,42,0.06);
      margin-bottom: 25px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .section-header h2 {
      font-size: 18px;
      color: #111827;
    }

    .section-header span {
      font-size: 12px;
      color: #6b7280;
    }

    /* Countdown */
    .exam-countdown {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      margin-bottom: 25px;
    }

    .exam-countdown h2 {
      font-size: 22px;
      margin-bottom: 10px;
    }

    .exam-subtitle {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .countdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin: 15px 0 10px;
    }

    .countdown-item {
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }

    .countdown-item .number {
      font-size: 28px;
      font-weight: 700;
    }

    .countdown-item .label {
      font-size: 13px;
      opacity: 0.9;
    }

    .quote {
      font-style: italic;
      margin-top: 10px;
      font-size: 14px;
      opacity: 0.96;
    }

    /* Update progress as 3 boxes */
    .update-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .update-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 14px 16px;
      border: 1px solid #e5e7eb;
    }

    .update-box label {
      display: block;
      margin-bottom: 6px;
      color: #4b5563;
      font-size: 13px;
      font-weight: 600;
    }

    .update-box input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      font-size: 14px;
    }

    .update-box input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }

    .update-actions {
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
    }

    .btn {
      padding: 11px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn:hover {
      box-shadow: 0 8px 18px rgba(102,126,234,0.35);
      transform: translateY(-1px);
    }

    /* Totals cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .stat-card {
      background: white;
      padding: 16px 18px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(15,23,42,0.06);
      border-left: 4px solid #667eea;
    }

    .stat-card h3 {
      color: #4b5563;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .stat-card .number {
      font-size: 26px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .stat-card .meta {
      font-size: 12px;
      color: #6b7280;
    }

    .empty-state {
      text-align: center;
      padding: 28px 10px;
      color: #9ca3af;
      font-size: 13px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .list a {
      font-size: 13px;
      color: #2563eb;
      text-decoration: none;
    }

    .list a:hover {
      text-decoration: underline;
    }

    .list-item {
      font-size: 13px;
      color: #111827;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eef2ff;
      color: #4f46e5;
      margin-left: 6px;
    }

    .syllabus-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 10px 0 5px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #22c55e 100%);
      width: 0%;
    }

    @media (max-width: 640px) {
      .header {
        padding: 16px 18px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .container {
        padding: 0 14px;
      }
    }
  </style>

  <script>
    // SAME SCRIPT_URL jo index/admin me use kar rahe ho
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFiEVyWCStmdOxaSz2AAboplrOXAJn0XuW614KRzLihSL60qL8zy3GEgBVvm0DQPcmQg/exec';

    // Access guard: only logged-in UPSC CSE users
    (function guardAccess() {
      const exam = localStorage.getItem('exam');
      const userId = localStorage.getItem('userId');

      if (!exam || !userId) {
        window.location.href = 'index.html';
        return;
      }
      if (exam !== 'UPSC CSE') {
        window.location.href = 'index.html';
        return;
      }
    })();
  </script>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <h1>UPSC CSE Dashboard</h1>
    <div class="header-right">
      <span id="userName">Welcome</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <!-- COUNTDOWN -->
    <section class="exam-countdown">
      <h2>UPSC CSE Prelims 2026</h2>
      <div class="exam-subtitle">
        Stay consistent. Daily discipline decides your rank.
      </div>
      <div class="countdown-grid">
        <div class="countdown-item">
          <div class="number" id="daysLeft">0</div>
          <div class="label">Days Left</div>
        </div>
        <div class="countdown-item">
          <div class="number" id="hoursLeft">0</div>
          <div class="label">Hours Left</div>
        </div>
      </div>
      <div class="quote" id="dailyQuote">
        The future belongs to those who believe in the beauty of their dreams.
      </div>
    </section>

    <!-- UPDATE DAILY PROGRESS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Update Your Daily Progress</h2>
        <span>Only for your UPSC CSE preparation</span>
      </div>
      <form id="progressForm" onsubmit="updateProgress(event)">
        <div class="update-grid">
          <div class="update-box">
            <label for="studyHours">Study Hours Today</label>
            <input type="number" id="studyHours" min="0" step="0.5" placeholder="e.g. 6" required>
          </div>
          <div class="update-box">
            <label for="topicsCovered">Topics Covered Today</label>
            <input type="number" id="topicsCovered" min="0" step="1" placeholder="e.g. 5" required>
          </div>
          <div class="update-box">
            <label for="mockTests">Mock Tests Completed</label>
            <input type="number" id="mockTests" min="0" step="1" placeholder="e.g. 1" required>
          </div>
          <div class="update-box update-actions">
            <button type="submit" class="btn">Save & Add to Totals</button>
          </div>
        </div>
      </form>
    </section>

    <!-- OVERALL TOTALS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Overall Progress Totals</h2>
        <span>Calculated from your daily entries</span>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Study Hours</h3>
          <div class="number" id="totalHours">0</div>
          <div class="meta">Prelims + Mains combined</div>
        </div>
        <div class="stat-card">
          <h3>Topics Covered</h3>
          <div class="number" id="totalTopics">0</div>
          <div class="meta">NCERT + Standard books</div>
        </div>
        <div class="stat-card">
          <h3>Mock Tests</h3>
          <div class="number" id="totalTests">0</div>
          <div class="meta">Prelims + GS Mains tests</div>
        </div>
      </div>
    </section>

    <!-- ANNOUNCEMENTS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Announcements</h2>
        <span>UPSC CSE related updates from admin</span>
      </div>
      <div id="announcements">
        <div class="empty-state">No announcements yet. Admin will update here.</div>
      </div>
    </section>

    <!-- DAILY TARGETS & RECENT TOPICS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Daily Targets & Recent Topics</h2>
        <span>Short-term focus areas for you</span>
      </div>
      <h3 style="font-size: 15px; color:#4b5563; margin-bottom:8px;">Daily Targets</h3>
      <div id="dailyTargets">
        <div class="empty-state">Admin will upload today's targets soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Recent Topics</h3>
      <div id="recentTopics">
        <div class="empty-state">No recent topics yet.</div>
      </div>
    </section>

    <!-- TEST PORTAL -->
    <section class="section-card">
      <div class="section-header">
        <h2>Test Portal</h2>
        <span>Mock tests · Test series · PYQs</span>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin-bottom:8px;">Mock Tests</h3>
      <div id="mockTestsList">
        <div class="empty-state">Admin will create mock tests soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Test Series</h3>
      <div id="testSeriesList">
        <div class="empty-state">Admin will upload test series soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Previous Year Papers</h3>
      <div id="pypList">
        <div class="empty-state">Admin will upload PYQ PDFs soon.</div>
      </div>
    </section>

    <!-- STUDY MATERIALS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Study Materials</h2>
        <span>Books · Current Affairs · Notes & PDFs</span>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin-bottom:8px;">Books</h3>
      <div id="booksList">
        <div class="empty-state">Admin will upload books list soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Current Affairs</h3>
      <div id="currentAffairsList">
        <div class="empty-state">Admin will upload current affairs soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Notes & PDFs</h3>
      <div id="notesList">
        <div class="empty-state">Admin will upload notes & PDFs soon.</div>
      </div>
    </section>

    <!-- SYLLABUS TRACKER -->
    <section class="section-card">
      <div class="section-header">
        <h2>Syllabus Tracker</h2>
        <span>Prelims & Mains completion overview</span>
      </div>

      <div class="syllabus-item">
        <span><strong>Prelims</strong></span>
        <span id="prelimsPercent">0% Complete</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="prelimsBar" style="width: 0%"></div>
      </div>

      <div class="syllabus-item">
        <span><strong>Mains</strong></span>
        <span id="mainsPercent">0% Complete</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="mainsBar" style="width: 0%"></div>
      </div>
    </section>

    <!-- PATH PRADARSHAK -->
    <section class="section-card">
      <div class="section-header">
        <h2>पथ प्रदर्शक</h2>
        <span>Daily motivation for UPSC CSE</span>
      </div>
      <div id="motivationalQuotes">
        <div class="empty-state">Admin will share motivational quotes soon.</div>
      </div>
    </section>
  </div>

  <script>
    // Local fallback quotes
    const fallbackQuotes = [
      'The future belongs to those who believe in the beauty of their dreams.',
      'Success is not final, failure is not fatal: it is the courage to continue that counts.',
      'Believe you can and you are halfway there.',
      'Hardships often prepare ordinary people for an extraordinary destiny.',
      'The only way to do great work is to love what you do.'
    ];

    function getRandomFallbackQuote() {
      return fallbackQuotes[Math.floor(Math.random() * fallbackQuotes.length)];
    }

    function setDailyQuote(text) {
      document.getElementById('dailyQuote').textContent =
        text || getRandomFallbackQuote();
    }

    // UPSC CSE Prelims 2026: 24 May 2026
    function updateCountdown() {
      const examDate = new Date('2026-05-24T09:00:00');
      const now = new Date();
      const diff = examDate - now;

      const days = Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)));
      const hours = Math.max(0, Math.floor(diff / (1000 * 60 * 60)));

      document.getElementById('daysLeft').textContent = days;
      document.getElementById('hoursLeft').textContent = hours;
    }

    function logout() {
      if (confirm('Logout from GyaanSetu?')) {
        localStorage.removeItem('userId');
        localStorage.removeItem('name');
        localStorage.removeItem('exam');
        window.location.href = 'index.html';
      }
    }

    // ========== STUDY PROGRESS ==========

    function updateProgress(e) {
      e.preventDefault();

      const userId = localStorage.getItem('userId');
      const exam   = localStorage.getItem('exam');

      if (!userId || !exam) {
        alert('Session expired. Please login again.');
        window.location.href = 'index.html';
        return;
      }

      const hours  = parseFloat(document.getElementById('studyHours').value) || 0;
      const topics = parseInt(document.getElementById('topicsCovered').value || '0', 10);
      const mocks  = parseInt(document.getElementById('mockTests').value || '0', 10);

      const url = `${SCRIPT_URL}?action=logStudy` +
                  `&userId=${encodeURIComponent(userId)}` +
                  `&exam=${encodeURIComponent(exam)}` +
                  `&hours=${encodeURIComponent(hours)}` +
                  `&topics=${encodeURIComponent(topics)}` +
                  `&mocks=${encodeURIComponent(mocks)}`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            throw new Error(data.message || 'Failed to save study log');
          }
          const totalsUrl = `${SCRIPT_URL}?action=getStudyTotals` +
                            `&userId=${encodeURIComponent(userId)}` +
                            `&exam=${encodeURIComponent(exam)}`;
          return fetch(totalsUrl).then(r => r.json());
        })
        .then(totals => {
          if (totals && totals.success) {
            document.getElementById('totalHours').textContent  = totals.totalHours || 0;
            document.getElementById('totalTopics').textContent = totals.totalTopics || 0;
            document.getElementById('totalTests').textContent  = totals.totalMocks || 0;
          }
          alert('Progress updated successfully!');
          document.getElementById('progressForm').reset();
        })
        .catch(err => {
          console.error('Update progress error:', err);
          alert('Error updating progress. Please try again.');
        });
    }

    function loadTotals() {
      const userId = localStorage.getItem('userId');
      const exam   = localStorage.getItem('exam');
      if (!userId || !exam) return;

      const totalsUrl = `${SCRIPT_URL}?action=getStudyTotals` +
                        `&userId=${encodeURIComponent(userId)}` +
                        `&exam=${encodeURIComponent(exam)}`;

      fetch(totalsUrl)
        .then(r => r.json())
        .then(totals => {
          if (totals && totals.success) {
            document.getElementById('totalHours').textContent  = totals.totalHours || 0;
            document.getElementById('totalTopics').textContent = totals.totalTopics || 0;
            document.getElementById('totalTests').textContent  = totals.totalMocks || 0;
          }
        })
        .catch(err => console.error('Load totals error:', err));
    }

    // ========== DASHBOARD CONTENT (targets, tests, materials, tracker, quotes) ==========

    function renderList(containerId, items, isLink = true) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (!items || !items.length) {
        container.innerHTML = '<div class="empty-state">No data yet.</div>';
        return;
      }
      const div = document.createElement('div');
      div.className = 'list';
      items.forEach(it => {
        if (isLink && it.url && it.title) {
          const a = document.createElement('a');
          a.href = it.url;
          a.target = '_blank';
          a.textContent = it.title;
          if (it.tag) {
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = it.tag;
            a.appendChild(span);
          }
          div.appendChild(a);
        } else {
          const p = document.createElement('div');
          p.className = 'list-item';
          p.textContent = it.text || it.title || '';
          div.appendChild(p);
        }
      });
      container.appendChild(div);
    }

    function loadDashboardContent() {
      const userId = localStorage.getItem('userId');
      if (!userId) return;

      const url = `${SCRIPT_URL}?action=getUpscDashboardContent&userId=${encodeURIComponent(userId)}`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data || !data.success) {
            setDailyQuote();
            return;
          }

          // Announcements
          renderList('announcements', data.announcements || [], false);

          // Daily targets & recent topics
          renderList('dailyTargets', data.dailyTargets || [], false);
          renderList('recentTopics', data.recentTopics || [], false);

          // Tests
          renderList('mockTestsList', data.mockTests || []);
          renderList('testSeriesList', data.testSeries || []);
          renderList('pypList', data.pyqPapers || []);

          // Study materials
          renderList('booksList', data.books || [], false);
          renderList('currentAffairsList', data.currentAffairs || []);
          renderList('notesList', data.notesPdfs || []);

          // Syllabus tracker
          if (data.syllabus) {
            const p = data.syllabus.prelimsPercent || 0;
            const m = data.syllabus.mainsPercent || 0;
            document.getElementById('prelimsPercent').textContent = p + '% Complete';
            document.getElementById('mainsPercent').textContent   = m + '% Complete';
            document.getElementById('prelimsBar').style.width = p + '%';
            document.getElementById('mainsBar').style.width   = m + '%';
          }

          // Path Pradarshak quotes
          renderList('motivationalQuotes', data.quotes || [], false);

          // Main quote
          setDailyQuote(data.dailyQuote || '');
        })
        .catch(err => {
          console.error('loadDashboardContent error:', err);
          setDailyQuote();
        });
    }

    window.onload = function() {
      document.getElementById('userName').textContent =
        localStorage.getItem('name') || 'Candidate';

      updateCountdown();
      setInterval(updateCountdown, 60 * 60 * 1000);

      setDailyQuote(); // initial
      loadTotals();
      loadDashboardContent();
    };
  </script>
</body>
</html>
