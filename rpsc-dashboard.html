<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RPSC Dashboard - GyaanSetu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 26px; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.15);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.6);
      cursor: pointer;
      font-size: 13px;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .container {
      max-width: 1400px;
      margin: 25px auto 40px;
      padding: 0 20px;
    }

    .section-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 12px rgba(15,23,42,0.06);
      margin-bottom: 25px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .section-header h2 {
      font-size: 18px;
      color: #111827;
    }

    .section-header span {
      font-size: 12px;
      color: #6b7280;
    }

    /* Countdown */
    .exam-countdown {
      background: linear-gradient(135deg, #6366f1 0%, #0ea5e9 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      margin-bottom: 25px;
    }

    .exam-countdown h2 {
      font-size: 22px;
      margin-bottom: 10px;
    }

    .exam-subtitle {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .countdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin: 15px 0 10px;
    }

    .countdown-item {
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }

    .countdown-item .title {
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .countdown-item .number {
      font-size: 22px;
      font-weight: 700;
    }

    .countdown-item .label {
      font-size: 12px;
      opacity: 0.9;
    }

    .quote {
      font-style: italic;
      margin-top: 10px;
      font-size: 14px;
      opacity: 0.96;
    }

    /* Update progress as 3 boxes */
    .update-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .update-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 14px 16px;
      border: 1px solid #e5e7eb;
    }

    .update-box label {
      display: block;
      margin-bottom: 6px;
      color: #4b5563;
      font-size: 13px;
      font-weight: 600;
    }

    .update-box input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      font-size: 14px;
    }

    .update-box input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }

    .update-actions {
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
    }

    .btn {
      padding: 11px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
    }

    .btn:hover {
      box-shadow: 0 8px 18px rgba(59,130,246,0.35);
      transform: translateY(-1px);
    }

    /* Totals cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .stat-card {
      background: white;
      padding: 16px 18px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(15,23,42,0.06);
      border-left: 4px solid #3b82f6;
    }

    .stat-card h3 {
      color: #4b5563;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .stat-card .number {
      font-size: 26px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .stat-card .meta {
      font-size: 12px;
      color: #6b7280;
    }

    .empty-state {
      text-align: center;
      padding: 28px 10px;
      color: #9ca3af;
      font-size: 13px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .list-item {
      font-size: 13px;
      color: #111827;
    }

    .syllabus-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 10px 0 5px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6 0%, #22c55e 100%);
      width: 0%;
    }

    @media (max-width: 640px) {
      .header {
        padding: 16px 18px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .container {
        padding: 0 14px;
      }
    }
  </style>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFiEVyWCStmdOxaSz2AAboplrOXAJn0XuW614KRzLihSL60qL8zy3GEgBVvm0DQPcmQg/exec';

    // Access guard: only logged-in RPSC users
    (function guardAccess() {
      const exam = localStorage.getItem('exam');
      const userId = localStorage.getItem('userId');

      if (!exam || !userId) {
        window.location.href = 'index.html';
        return;
      }
      if (exam !== 'RPSC') {
        window.location.href = 'index.html';
        return;
      }
    })();
  </script>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <h1>RPSC Dashboard</h1>
    <div class="header-right">
      <span id="userName">Welcome</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <!-- COUNTDOWN: RAS Pre, 1st Grade, 2nd Grade -->
    <section class="exam-countdown">
      <h2>RPSC Exams 2026</h2>
      <div class="exam-subtitle">
        Roz ka disciplined study aapko agle RPSC panel ke saamne confident khada karta hai.
      </div>
      <div class="countdown-grid">
        <div class="countdown-item">
          <div class="title">RAS Pre 2026</div>
          <div class="number" id="daysRas">0</div>
          <div class="label">Days Left</div>
        </div>
        <div class="countdown-item">
          <div class="title">1st Grade 2026</div>
          <div class="number" id="daysG1">0</div>
          <div class="label">Days Left</div>
        </div>
        <div class="countdown-item">
          <div class="title">2nd Grade 2026</div>
          <div class="number" id="daysG2">0</div>
          <div class="label">Days Left</div>
        </div>
      </div>
      <div class="quote" id="dailyQuote">
        Aaj ka ek extra revision page, kal interview board ke saamne extra confidence banega.
      </div>
    </section>

    <!-- UPDATE DAILY PROGRESS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Update Your Daily Progress</h2>
        <span>Track your RPSC preparation honestly</span>
      </div>
      <form id="progressForm" onsubmit="updateProgress(event)">
        <div class="update-grid">
          <div class="update-box">
            <label for="studyHours">Study Hours Today</label>
            <input type="number" id="studyHours" min="0" step="0.5" placeholder="e.g. 6" required>
          </div>
          <div class="update-box">
            <label for="topicsCovered">Topics Covered Today</label>
            <input type="number" id="topicsCovered" min="0" step="1" placeholder="Chapters/Topics" required>
          </div>
          <div class="update-box">
            <label for="mockTests">Questions / Tests</label>
            <input type="number" id="mockTests" min="0" step="1" placeholder="MCQs or tests count" required>
          </div>
          <div class="update-box update-actions">
            <button type="submit" class="btn">Save & Add to Totals</button>
          </div>
        </div>
      </form>
    </section>

    <!-- OVERALL TOTALS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Overall Progress Totals</h2>
        <span>Calculated from your daily entries</span>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Study Hours</h3>
          <div class="number" id="totalHours">0</div>
          <div class="meta">GS · Rajasthan GK · Optional combined</div>
        </div>
        <div class="stat-card">
          <h3>Topics Covered</h3>
          <div class="number" id="totalTopics">0</div>
          <div class="meta">Syllabus units completed</div>
        </div>
        <div class="stat-card">
          <h3>Questions / Tests</h3>
          <div class="number" id="totalTests">0</div>
          <div class="meta">MCQs / test papers attempted</div>
        </div>
      </div>
    </section>

    <!-- ANNOUNCEMENTS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Announcements</h2>
        <span>RPSC related updates from admin</span>
      </div>
      <div id="announcements">
        <div class="empty-state">No announcements yet. Admin will update here.</div>
      </div>
    </section>

    <!-- DAILY TARGETS & RECENT TOPICS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Daily Targets & Recent Topics</h2>
        <span>GS · Rajasthan GK · Optional focus</span>
      </div>
      <h3 style="font-size: 15px; color:#4b5563; margin-bottom:8px;">Daily Targets</h3>
      <div id="dailyTargets">
        <div class="empty-state">Admin will upload today's targets soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Recent Topics</h3>
      <div id="recentTopics">
        <div class="empty-state">No recent topics yet.</div>
      </div>
    </section>

    <!-- TEST PORTAL -->
    <section class="section-card">
      <div class="section-header">
        <h2>Test Portal</h2>
        <span>Mock Tests · Previous Year Questions</span>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin-bottom:8px;">Mock Tests</h3>
      <div id="testSeriesList">
        <div class="empty-state">Admin will upload mock tests soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Previous Year Questions (PYQs)</h3>
      <div id="pypList">
        <div class="empty-state">Admin will upload PYQ PDFs soon.</div>
      </div>
    </section>

    <!-- STUDY MATERIALS -->
    <section class="section-card">
      <div class="section-header">
        <h2>Study Materials</h2>
        <span>Standard books · Rajasthan specific notes</span>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin-bottom:8px;">Books</h3>
      <div id="booksList">
        <div class="empty-state">Admin will upload books list soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Important Charts / Maps</h3>
      <div id="formulaList">
        <div class="empty-state">Admin will upload charts & maps soon.</div>
      </div>

      <h3 style="font-size: 15px; color:#4b5563; margin:20px 0 8px;">Notes & PDFs</h3>
      <div id="notesList">
        <div class="empty-state">Admin will upload notes & PDFs soon.</div>
      </div>
    </section>

    <!-- SYLLABUS TRACKER -->
    <section class="section-card">
      <div class="section-header">
        <h2>Syllabus Tracker</h2>
        <span>GS · Rajasthan GK · Optional completion overview</span>
      </div>

      <div class="syllabus-item">
        <span><strong>GS</strong></span>
        <span id="gsPercent">0% Complete</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="gsBar" style="width: 0%"></div>
      </div>

      <div class="syllabus-item">
        <span><strong>Rajasthan GK</strong></span>
        <span id="rajPercent">0% Complete</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="rajBar" style="width: 0%"></div>
      </div>

      <div class="syllabus-item">
        <span><strong>Optional / Subject</strong></span>
        <span id="optPercent">0% Complete</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="optBar" style="width: 0%"></div>
      </div>
    </section>

    <!-- PATH PRADARSHAK -->
    <section class="section-card">
      <div class="section-header">
        <h2>पथ प्रदर्शक</h2>
        <span>Daily motivation for RPSC aspirants</span>
      </div>
      <div id="motivationalQuotes">
        <div class="empty-state">Admin will share motivational quotes soon.</div>
      </div>
    </section>
  </div>

  <script>
    // RPSC-focused quotes
    const rpscQuotes = [
      'Aaj likhi gayi har answer practice, kal Mains copy par clarity banegi.',
      'Classroom me khade hone ka sapna, aaj ke disciplined self-study se poora hoga.',
      'Rajasthan GK ka ek-ek page aapko interview panel ke sawalon se bachata hai.',
      'Jo candidate roj thoda likhta hai, wahi paper me pura likh paata hai.',
      'Ek extra mock test aaj, merit list me ek extra step upar kal.'
    ];

    function loadDailyQuote() {
      const todayKey = new Date().toISOString().slice(0, 10);
      const stored = localStorage.getItem('rpscQuote');
      let quote;

      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (parsed.date === todayKey) {
            quote = parsed.text;
          }
        } catch (e) {}
      }

      if (!quote) {
        quote = rpscQuotes[Math.floor(Math.random() * rpscQuotes.length)];
        localStorage.setItem('rpscQuote', JSON.stringify({ date: todayKey, text: quote }));
      }

      document.getElementById('dailyQuote').textContent = quote;
    }

    // Countdown
    function updateCountdown() {
      const rasDate = new Date('2026-06-21T10:00:00');
      const g1Date  = new Date('2026-05-31T10:00:00');
      const g2Date  = new Date('2026-07-12T10:00:00');

      const now = new Date();

      const dRas = Math.max(0, Math.floor((rasDate - now) / (1000 * 60 * 60 * 24)));
      const dG1  = Math.max(0, Math.floor((g1Date  - now) / (1000 * 60 * 60 * 24)));
      const dG2  = Math.max(0, Math.floor((g2Date  - now) / (1000 * 60 * 60 * 24)));

      document.getElementById('daysRas').textContent = dRas;
      document.getElementById('daysG1').textContent  = dG1;
      document.getElementById('daysG2').textContent  = dG2;
    }

    function logout() {
      if (confirm('Logout from GyaanSetu?')) {
        localStorage.removeItem('userId');
        localStorage.removeItem('name');
        localStorage.removeItem('exam');
        window.location.href = 'index.html';
      }
    }

    // STUDY PROGRESS
    function updateProgress(e) {
      e.preventDefault();

      const userId = localStorage.getItem('userId');
      const exam   = localStorage.getItem('exam');

      if (!userId || !exam) {
        alert('Session expired. Please login again.');
        window.location.href = 'index.html';
        return;
      }

      const hours  = parseFloat(document.getElementById('studyHours').value) || 0;
      const topics = parseInt(document.getElementById('topicsCovered').value || '0', 10);
      const mocks  = parseInt(document.getElementById('mockTests').value || '0', 10);

      const url = `${SCRIPT_URL}?action=logStudy` +
                  `&userId=${encodeURIComponent(userId)}` +
                  `&exam=${encodeURIComponent(exam)}` +
                  `&hours=${encodeURIComponent(hours)}` +
                  `&topics=${encodeURIComponent(topics)}` +
                  `&mocks=${encodeURIComponent(mocks)}`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            throw new Error(data.message || 'Failed to save study log');
          }
          const totalsUrl = `${SCRIPT_URL}?action=getStudyTotals` +
                            `&userId=${encodeURIComponent(userId)}` +
                            `&exam=${encodeURIComponent(exam)}`;
          return fetch(totalsUrl).then(r => r.json());
        })
        .then(totals => {
          if (totals && totals.success) {
            document.getElementById('totalHours').textContent  = totals.totalHours || 0;
            document.getElementById('totalTopics').textContent = totals.totalTopics || 0;
            document.getElementById('totalTests').textContent  = totals.totalMocks || 0;
          }
          alert('Progress updated successfully!');
          document.getElementById('progressForm').reset();
        })
        .catch(err => {
          console.error('Update progress error:', err);
          alert('Error updating progress. Please try again.');
        });
    }

    function loadTotals() {
      const userId = localStorage.getItem('userId');
      const exam   = localStorage.getItem('exam');
      if (!userId || !exam) return;

      const totalsUrl = `${SCRIPT_URL}?action=getStudyTotals` +
                        `&userId=${encodeURIComponent(userId)}` +
                        `&exam=${encodeURIComponent(exam)}`;

      fetch(totalsUrl)
        .then(r => r.json())
        .then(totals => {
          if (totals && totals.success) {
            document.getElementById('totalHours').textContent  = totals.totalHours || 0;
            document.getElementById('totalTopics').textContent = totals.totalTopics || 0;
            document.getElementById('totalTests').textContent  = totals.totalMocks || 0;
          }
        })
        .catch(err => console.error('Load totals error:', err));
    }

    // Common list renderer
    function renderList(containerId, items) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      if (!items || !items.length) {
        container.innerHTML = '<div class="empty-state">No data yet.</div>';
        return;
      }
      const div = document.createElement('div');
      div.className = 'list';
      items.forEach(text => {
        const p = document.createElement('div');
        p.className = 'list-item';
        p.textContent = text;
        div.appendChild(p);
      });
      container.appendChild(div);
    }

    // Dashboard content from DashboardContent sheet (RPSC)
    function loadRpscDashboardContent() {
      const url = `${SCRIPT_URL}?action=getDashboardContent&examType=RPSC`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data || !data.success || !data.payload) return;
          const p = data.payload;

          if (p.announcements) {
            renderList('announcements', p.announcements.items || []);
          }
          if (p.dailyTargets) {
            renderList('dailyTargets', p.dailyTargets.items || []);
          }
          if (p.recentTopics) {
            renderList('recentTopics', p.recentTopics.items || []);
          }
          if (p.mockTests) {
            renderList('testSeriesList', p.mockTests.items || []);
          }
          if (p.pyqPapers) {
            renderList('pypList', p.pyqPapers.items || []);
          }
          if (p.books) {
            renderList('booksList', p.books.items || []);
          }
          if (p.formulaSheets) {
            renderList('formulaList', p.formulaSheets.items || []);
          }
          if (p.notesPdfs) {
            renderList('notesList', p.notesPdfs.items || []);
          }

          if (p.syllabus) {
            const s = p.syllabus;
            const gs  = s.gsPercent  || 0;
            const raj = s.rajPercent || 0;
            const opt = s.optPercent || 0;

            document.getElementById('gsPercent').textContent  = gs  + '% Complete';
            document.getElementById('rajPercent').textContent = raj + '% Complete';
            document.getElementById('optPercent').textContent = opt + '% Complete';

            document.getElementById('gsBar').style.width  = gs  + '%';
            document.getElementById('rajBar').style.width = raj + '%';
            document.getElementById('optBar').style.width = opt + '%';
          }

          if (p.quotes && Array.isArray(p.quotes.items) && p.quotes.items.length) {
            renderList('motivationalQuotes', p.quotes.items || []);
          }
        })
        .catch(err => console.error('loadRpscDashboardContent error:', err));
    }

    window.onload = function() {
      document.getElementById('userName').textContent =
        localStorage.getItem('name') || 'Candidate';

      updateCountdown();
      setInterval(updateCountdown, 60 * 60 * 1000);

      loadDailyQuote();
      loadTotals();
      loadRpscDashboardContent();
    };
  </script>
</body>
</html>
